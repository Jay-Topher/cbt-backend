generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Category {
  SCIENCE
  ARTS
}

enum QuestionType {
  MCQ
}

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Student {
  id        String   @id @default(cuid())
  firstName String
  lastName  String
  username  String   @unique
  password  String
  category  Category
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions ExamSession[]
}

model Subject {
  id              String           @id @default(cuid())
  name            String           @unique
  code            String           @unique
  defaultMinutes  Int              @default(25)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  questions       Question[]
  subjectAttempts SubjectAttempt[]
}

model Question {
  id          String       @id @default(cuid())
  subjectId   String
  prompt      String
  options     String[]
  answerIndex Int
  type        QuestionType @default(MCQ)
  isSandbox   Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  subject Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  answers Answer[] // Opposite relation field

  @@index([subjectId])
}

model ExamSession {
  id              String           @id @default(cuid())
  studentId       String
  status          String           @default("IN_PROGRESS") // IN_PROGRESS | COMPLETED
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  subjectAttempts SubjectAttempt[]

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
}

model SubjectAttempt {
  id            String    @id @default(cuid())
  sessionId     String
  subjectId     String
  startedAt     DateTime? // set when student starts
  endedAt       DateTime? // set when finished or time elapsed
  durationMin   Int // minutes allocated (copied from Subject.defaultMinutes)
  questionOrder String[] // array of Question IDs in randomized order
  answers       Answer[]
  score         Int? // computed after submission
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  session ExamSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  subject Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([sessionId, subjectId])
}

model Answer {
  id            String    @id @default(cuid())
  attemptId     String
  questionId    String
  selectedIndex Int? // null until answered
  isCorrect     Boolean?
  answeredAt    DateTime?

  attempt  SubjectAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question Question       @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([attemptId, questionId])
  @@index([questionId])
}
